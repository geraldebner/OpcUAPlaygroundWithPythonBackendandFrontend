name: Build Complete VentilTester Application

permissions:
  contents: write

on:
  push:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build-all:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Backend Build
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Build Backend (Windows)
      run: |
        dotnet restore
        dotnet publish --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishReadyToRun=true --output ./publish/backend
      working-directory: ./VentilTesterBackend
      
    # Frontend Build
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install pkg globally
      run: npm install -g pkg
        
    - name: Build Frontend Executable
      run: |
        npm ci
        npm run build
        pkg . --targets win-x64 --icon app.ico --output dist/VentilTesterFrontend.exe
      working-directory: ./VentiltesterFrontend
      env:
        CI: false
        GENERATE_SOURCEMAP: false
        
    # Package Everything
    - name: Create complete application package
      run: |
        # Create package structure
        New-Item -ItemType Directory -Path ./VentilTesterApp -Force
        New-Item -ItemType Directory -Path ./VentilTesterApp/backend -Force
        New-Item -ItemType Directory -Path ./VentilTesterApp/frontend -Force
        
        # Copy backend
        Copy-Item -Path ./VentilTesterBackend/publish/backend/* -Destination ./VentilTesterApp/backend/ -Recurse
        
        # Copy and update appsettings.json with correct path
        $config = Get-Content ./VentilTesterBackend/appsettings.json | ConvertFrom-Json
        $config.SpsMappingPath = "SPSData\Mapping_Ventiltester_V4_NS5.xml"
        $config | ConvertTo-Json -Depth 10 | Set-Content ./VentilTesterApp/backend/appsettings.json
        
        # Copy SPSData folder to backend directory
        Copy-Item -Path ./SPSData -Destination ./VentilTesterApp/backend/SPSData -Recurse -ErrorAction SilentlyContinue
        
        # Copy frontend executable and batch launcher
        Copy-Item -Path ./VentiltesterFrontend/dist/VentilTesterFrontend.exe -Destination ./VentilTesterApp/frontend/
        @"
@echo off
echo Starting VentilTester Frontend...
echo.
echo The frontend will be available at: http://localhost:3000
echo Press Ctrl+C to stop
echo.
"%~dp0VentilTesterFrontend.exe"
pause
"@ | Out-File -FilePath ./VentilTesterApp/frontend/START_FRONTEND.bat -Encoding ASCII
        
        # Install frontend production dependencies
        Push-Location ./VentilTesterApp/frontend
        npm install --production --omit=dev
        Pop-Location
        
        # Create README
        @"
        # VentilTester Application
        
        ## Installation and Usage
        
        ### Backend
        1. Navigate to the `backend` folder
        2. Edit `appsettings.json` to configure:
           - OPC UA endpoint URL
           - Database connection (SQLite or PostgreSQL)
           - SPS mapping path
        3. Run `VentilTesterBackend.exe` (Windows)
        4. Backend will start on http://localhost:5000
        
        ### Frontend
        1. Navigate to the `frontend` folder
        2. Run `VentilTesterFrontend.exe` directly or `START_FRONTEND.bat`
        3. Frontend will start on http://localhost:3000
        4. Open your browser at http://localhost:3000
        
        ### Requirements
        - Backend: Windows x64 (self-contained, no .NET installation needed)
        - Frontend: Standalone executable (no additional installation needed!)
        - OPC UA server must be accessible from the backend
        
        ### Default Configuration
        - Backend: http://localhost:5000
        - Frontend: Connects to backend at http://localhost:5000
        - Database: SQLite (ventiltester.db) or PostgreSQL
        
        Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        Commit: ${{ github.sha }}
        "@ | Out-File -FilePath ./VentilTesterApp/README.md -Encoding UTF8
        
        # Create startup script
        @"
        @echo off
        echo ========================================
        echo    VentilTester Application Startup
        echo ========================================
        echo.
        echo Starting Backend...
        cd backend
        start "VentilTester Backend" VentilTesterBackend.exe
        cd ..
        echo Backend started on http://localhost:5000
        echo.
        echo Starting Frontend...
        cd frontend
        start "VentilTester Frontend" START_FRONTEND.bat
        cd ..
        echo.
        echo ========================================
        echo Application is starting...
        echo Backend: http://localhost:5000
        echo Frontend: http://localhost:3000
        echo ========================================
        echo.
        echo Press any key to exit...
        pause > nul
        "@ | Out-File -FilePath ./VentilTesterApp/START.bat -Encoding ASCII
        
        # Create zip
        Compress-Archive -Path ./VentilTesterApp/* -DestinationPath ./VentilTesterApp-Complete.zip
        
    - name: Upload complete application
      uses: actions/upload-artifact@v4
      with:
        name: VentilTesterApp-Complete
        path: ./VentilTesterApp-Complete.zip
        retention-days: 90
        
    - name: Create Release
      if: github.event_name == 'push' || github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: VentilTester Complete Application v${{ github.run_number }}
        body: |
          Complete VentilTester Application Package
          
          This package includes:
          - Backend (Windows x64, self-contained)
          - Frontend (static files, ready to serve)
          - Configuration files
          - README with installation instructions
          
          Download, extract, configure, and run!
        draft: false
        prerelease: false
        files: ./VentilTesterApp-Complete.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
